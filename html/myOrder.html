<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300..700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/dashboard.css">
  <link rel="stylesheet" href="../css/navbar.css">
</head>

<body>
  <div id="navbar-container"></div>
  <div class="container mb-5 " style="margin-top: 75px; min-height: 70vh;">
    <h3 class="fw-bold text-primary mb-4">My Orders</h3>
    <div id="ordersContainer"></div>
  </div>

  <div id="footer-container"></div>
  <script>
  const container = document.getElementById("ordersContainer");
  const user = JSON.parse(localStorage.getItem("user"));

  if (!user) {
    alert("You must login first!");
    window.location.href = "../html/login.html";
  }

  fetch(`http://localhost:3000/orders?userId=${user.id}`)
    .then(res => res.json())
    .then(data => {
      container.innerHTML = "";

      if (!data || data.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5">
            <i class="fa-solid fa-box-open fa-5x text-secondary mb-3"></i>
            <h4 class="text-muted">You have no orders yet</h4>
            <a href="../html/products.html" class="btn btn-dark mt-3">
              Start Shopping
            </a>
          </div>
        `;
        return;
      }

      data.forEach(order => {
        let productList = order.products || order.items || [];
        let total = 0;

        const card = document.createElement("div");
        card.className = "border rounded p-4 mb-4 shadow-sm";

        const headerDiv = document.createElement("div");
        headerDiv.className = "d-flex justify-content-between align-items-center mb-2";

        const strong = document.createElement("strong");
        strong.textContent = `Order #${order.id}`;

        const badge = document.createElement("span");
        const status = (order.status || "PENDING").toUpperCase();

        if (status === "COMPLETED") {
          badge.className = "badge bg-success";
        } 
        else if (status === "REJECTED") {
          badge.className = "badge bg-danger";
        } 
        else {
          badge.className = "badge bg-warning";
        }

        badge.textContent = status;

        headerDiv.appendChild(strong);
        headerDiv.appendChild(badge);

        // Products
        const productsDiv = document.createElement("div");

        productList.forEach(p => {
          const qty = p.quantity || p.qty || 1;
          const price = p.price || 0;
          total += price * qty;

          const itemDiv = document.createElement("div");
          itemDiv.className = "d-flex justify-content-between";

          itemDiv.innerHTML = `
            <span>${p.title || p.name} x ${qty}</span>
            <span>$${(price * qty).toFixed(2)}</span>
          `;

          productsDiv.appendChild(itemDiv);
        });

        // Total
        const totalDiv = document.createElement("div");
        totalDiv.className = "d-flex justify-content-between fw-bold mt-3";

        totalDiv.innerHTML = `
          <span>Total:</span>
          <span>$${total.toFixed(2)}</span>
        `;

        card.appendChild(headerDiv);
        card.appendChild(productsDiv);
        card.appendChild(document.createElement("hr"));
        card.appendChild(totalDiv);

        container.appendChild(card);
      });
    })
    .catch(err => {
      console.error("Error fetching orders:", err);
      container.innerHTML = "<p>Error loading orders</p>";
    });
  </script>
  <script src="../js/navbar.js"></script>
  <script src="../js/footr.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
