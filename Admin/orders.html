<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Orders | Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/dashboard.css">

  <style>
    #sidebar {
      min-height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
    }

    .order-card.completed {
      background: #addbc7;
      border-left: 5px solid #198754;
    }

    .order-card.rejected {
      background: #f8d7da;
      border-left: 5px solid #dc3545;
    }

    .order-card.pending {
      background: #f7e8ba;
      border-left: 5px solid #ffc107;
    }
  </style>

</head>

<body>
  <!-- Hamburger button for small screens -->
  <nav class="navbar bg-dark navbar-dark d-md-none">
    <div class="container-fluid">
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mobileSidebar"
        aria-controls="mobileSidebar" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <span class="navbar-brand mb-0 h1">Admin Panel</span>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">

      <!-- Sidebar -->
      <div id="sidebar" class="col-4 col-md-2 bg-dark text-white p-0 d-none d-md-block">
        <div class="p-3">
          <h4>Admin Panel</h4>
          <ul class="nav flex-column">
            <ul class="nav flex-column">
              <li class="nav-item"> <a href="dashboard.html" class="nav-link text-white">Dashboard</a> </li>
              <li class="nav-item"> <a href="adminProducts.html" class="nav-link text-white">Products</a> </li>
              <li class="nav-item"> <a href="adminCategories.html" class="nav-link text-white">Categories</a> </li>
              <li class="nav-item"> <a href="orders.html" class="nav-link text-white">Orders</a> </li>
              <li class="nav-item mt-3"> <button class="btn btn-danger w-100" onclick="logout()">Logout</button> </li>
            </ul>
          </ul>
        </div>
      </div>

      <!-- Sidebar for small screens -->
      <div class="collapse bg-dark text-white" id="mobileSidebar">
        <div class="p-3">
          <h4>Admin Panel</h4>
          <ul class="nav flex-column">
            <li class="nav-item"><a href="dashboard.html" class="nav-link text-white">Dashboard</a></li>
            <li class="nav-item"><a href="adminProducts.html" class="nav-link text-white">Products</a></li>
            <li class="nav-item"><a href="adminCategories.html" class="nav-link text-white">Categories</a></li>
            <li class="nav-item"><a href="orders.html" class="nav-link text-white">Orders</a></li>
            <li class="nav-item mt-3">
              <button class="btn btn-danger w-100" onclick="logout()">Logout</button>
            </li>
          </ul>
        </div>
      </div>


      <!-- Main Content -->
      <div class="col-md-10 offset-md-2 my-5">
        <h3 class="fw-bold mb-4">Orders Management</h3>
        <div class="mb-4" style="width:100%;">
          <select id="statusFilter" class="form-select">
            <option value="ALL">All Orders</option>
            <option value="PENDING">Pending</option>
            <option value="COMPLETED">Completed</option>
            <option value="REJECTED">Rejected</option>
          </select>
        </div>
        <div id="ordersContainer"></div>
      </div>
    </div>
  </div>

  <script>
    const container = document.getElementById("ordersContainer");
    let allOrders = [];

    function renderOrders(orders) {
      container.innerHTML = "";

      if (!orders || orders.length === 0) {
        container.innerHTML = "<p>No orders found</p>";
        return;
      }

      orders.forEach(order => {
        let productList = order.products || order.items || [];
        let total = 0;

        const card = document.createElement("div");
        card.className = "border rounded p-4 mb-4 shadow-sm order-card";
        card.id = `order-${order.id}`;

        const productsDiv = document.createElement("div");
        productList.forEach(p => {
          const qty = p.quantity || p.qty || 1;
          const price = p.price || p.pricePerItem || 0;
          total += price * qty;

          const itemDiv = document.createElement("div");
          itemDiv.className = "d-flex justify-content-between";
          itemDiv.innerHTML =
            `<span>${p.title || p.name} x ${qty}</span>
             <span>$${(price * qty).toFixed(2)}</span>`;
          productsDiv.appendChild(itemDiv);
        });

        const headerDiv = document.createElement("div");
        headerDiv.className = "d-flex justify-content-between align-items-center mb-2";

        const strong = document.createElement("strong");
        strong.textContent = `Order #${order.id}`;

        const badge = document.createElement("span");
        badge.textContent = order.status || "PENDING";

        headerDiv.appendChild(strong);
        headerDiv.appendChild(badge);

        const totalDiv = document.createElement("div");
        totalDiv.className = "d-flex justify-content-between fw-bold mt-2";
        totalDiv.innerHTML = `<span>Total:</span><span>$${total.toFixed(2)}</span>`;

        const buttonsDiv = document.createElement("div");
        buttonsDiv.className = "mt-3 d-flex gap-2 order-buttons";

        const confirmBtn = document.createElement("button");
        confirmBtn.className = "btn btn-success btn-sm";
        confirmBtn.textContent = "Confirm";

        const rejectBtn = document.createElement("button");
        rejectBtn.className = "btn btn-danger btn-sm";
        rejectBtn.textContent = "Reject";

        buttonsDiv.appendChild(confirmBtn);
        buttonsDiv.appendChild(rejectBtn);

        const statusUpper = (order.status || "PENDING").toString().trim().toUpperCase();
        card.classList.add(statusUpper.toLowerCase());

        card.appendChild(headerDiv);
        card.appendChild(productsDiv);
        card.appendChild(document.createElement("hr"));
        card.appendChild(totalDiv);

        if (statusUpper === "COMPLETED") {
          badge.className = "badge bg-success";
        } else if (statusUpper === "REJECTED") {
          badge.className = "badge bg-danger";
        } else {
          badge.className = "badge bg-warning";

          confirmBtn.onclick = () =>
            updateOrderStatus(order.id, "COMPLETED");

          rejectBtn.onclick = () =>
            updateOrderStatus(order.id, "REJECTED");

          card.appendChild(buttonsDiv); // الأزرار فقط للحالات pending
        }

        container.appendChild(card);
      });
    }

    function updateOrderStatus(id, status) {
      fetch(`http://localhost:3000/orders/${id}`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      })
        .then(() => {
          const order = allOrders.find(o => o.id == id);
          if (order) order.status = status;
          applyFilter();
        });
    }

    function applyFilter() {
      const currentFilter = document.getElementById("statusFilter").value;
      if (currentFilter === "ALL") {
        renderOrders(allOrders);
      } else {
        const filtered = allOrders.filter(
          o => (o.status || "PENDING").toUpperCase() === currentFilter
        );
        renderOrders(filtered);
      }
    }

    fetch("http://localhost:3000/orders")
      .then(res => res.json())
      .then(data => {
        allOrders = data;
        renderOrders(allOrders);
      });

document.getElementById("statusFilter").addEventListener("change", applyFilter);

  </script>

  <script src="sidebar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
